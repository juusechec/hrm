{% block javascripts %}
<script>
$(document).ready(function(){
    changeVisibilityOfFields($('#contrato_idTipoContrato').val());
    $('#contrato_idTipoContrato').change(function () {
        const valor = $(this).val();
        changeVisibilityOfFields(valor);
    });
    $('#contrato_fechaInicio_day').change(updateFechaFin);
    $('#contrato_fechaInicio_month').change(updateFechaFin);
    $('#contrato_fechaInicio_year').change(updateFechaFin);

    $('#contrato_calcularFechaFin').change(function () {
        const valor = $(this).val();
        updateFinalDateField(valor);
    });
});

function changeVisibilityOfFields(valor) {
    console.log('valor', valor);
    if (valor === '1') { // Obra o Labor
        showField('contrato_objeto');
        showField('contrato_obraOLabor');
        hideField('contrato_calcularFechaFin');
        hideField('contrato_restaFechas');
        hideField('contrato_idOtrosi');
    } else if (valor === '2') { // Indefinido
        hideField('contrato_objeto');
        showField('contrato_obraOLabor');
        hideField('contrato_calcularFechaFin');
        hideField('contrato_restaFechas');
        hideField('contrato_idOtrosi');
    } else if (valor === '3') { // Fijo
        hideField('contrato_objeto');
        showField('contrato_obraOLabor');
        showField('contrato_calcularFechaFin');
        showField('contrato_restaFechas');
        hideField('contrato_idOtrosi');
    } else if (valor === '4') { // De servicio
        showField('contrato_objeto');
        hideField('contrato_obraOLabor');
        showField('contrato_calcularFechaFin');
        showField('contrato_restaFechas');
        showField('contrato_idOtrosi');
    } else if (valor === '5') { // Pasante
        showField('contrato_objeto');
        hideField('contrato_obraOLabor');
        hideField('contrato_calcularFechaFin');
        hideField('contrato_restaFechas');
        hideField('contrato_idOtrosi');
    } else if (valor === '6') { // Aprendizaje
        showField('contrato_objeto');
        hideField('contrato_obraOLabor');
        hideField('contrato_calcularFechaFin');
        hideField('contrato_restaFechas');
        hideField('contrato_idOtrosi');
    } else {
        hideField('contrato_objeto');
        hideField('contrato_obraOLabor');
        hideField('contrato_calcularFechaFin');
        hideField('contrato_restaFechas');
        hideField('contrato_idOtrosi');
    }
}

function updateFinalDateField(valor) {
    console.log('valor', valor);
    $('#contrato_restaFechas').val('Sin calcular...');
    const id = 'contrato_fechaInicio';
    let mes = $('#' + id + '_month').val();
    let dia = $('#' + id + '_day').val();
    let ano = $('#' + id + '_year').val();
    console.log(`Fecha inicio: ${mes}-${dia}-${ano}`);
    const fechaInicio = new Date(`${ano}-${mes}-${dia}T00:00:00.000Z`);
    if (isNaN(fechaInicio)) {
        window.alert('La fecha de inicio es inválida.');
        throw new Error('La fecha de inicio es inválida.');
    }
    if (mes !== '') {
        mes = (parseInt(mes) + parseInt(valor)) + '';
    }
    if (parseInt(mes) > 12) {
        ano = (parseInt(ano) + 1) + '';
        mes = (parseInt(mes) - 12) + '';
    }
    if (dia !== '') {
        dia = (parseInt(dia) - 1) + '';
    }
    if (parseInt(dia) < '1') {
        dia = '30';
        console.log('mes', mes);
        mes = (parseInt(mes) - 1) + '';
        console.log('mes anterior', mes);
        if (parseInt(mes) < 1) {
            mes = '12';
            ano = (parseInt(ano) - 1) + '';
        }
    }
    const finalId = 'contrato_fechaFin';
    console.log(`Fecha fin: ${mes}-${dia}-${ano}`);
    const fechaFin = new Date(`${ano}-${mes}-${dia}T00:00:00.000Z`);
    if (isNaN(fechaFin)) {
        window.alert('Esto es vergonzoso, no hemos podido calcular la fecha final.');
        throw new Error('Esto es vergonzoso, no hemos podido calcular la fecha final.');
    }
    let fechaDiff = fechaFin - fechaInicio;
    console.log(fechaInicio, fechaFin, fechaDiff);
    fechaDiff = fechaDiff / 1000 / 3600 / 24;
    fechaDiff = fechaDiff + ' días';
    $('#contrato_restaFechas').val(fechaDiff);
    setDate(finalId, mes, dia, ano);
}

function setDate(id, month, day, year) {
    $('#' + id + '_month').val(month);
    $('#' + id + '_month').selectpicker('refresh');
    $('#' + id + '_day').val(day);
    $('#' + id + '_day').selectpicker('refresh');
    $('#' + id + '_year').val(year);
    $('#' + id + '_year').selectpicker('refresh');
}

function updateFechaFin() {
    const valor = $('#contrato_calcularFechaFin').val();
    updateFinalDateField(valor);
}
</script>
{% endblock %}